# Bookkeeping 專案功能代碼審計報告

- 審計日期：2026-02-09
- 審計範圍：`client/`、`server/`、`scripts/` 主要功能代碼
- 審計方式：靜態程式碼審查 + 建置驗證（`npm run build`）
- 審計性質：快速功能與安全風險審計（非完整滲透測試）

## 一、審計摘要

- 高風險：2 項
- 中風險：4 項
- 低風險：1 項
- 冗餘代碼：4 項（2 項未使用、1 項可簡化、1 項未掛載）
- 建置結果：前端打包成功（Vite build passed）

整體可運行，但在「驗證安全性、輸入校驗、時區一致性、資料語義一致性」有明顯缺口，建議先修高風險項目再處理資料一致性問題。

## 二、詳細發現

### F-01（高）JWT 存在弱預設密鑰，可被偽造 Token

- 風險等級：高
- 位置：`server/middleware/auth.js:3`
- 問題描述：`JWT_SECRET` 未設定時會使用 `fallback-secret`。
- 影響：攻擊者可利用已知密鑰自行簽發有效 JWT，直接繞過登入。
- 修正建議：
  - 移除 fallback。
  - 啟動時強制檢查 `JWT_SECRET`，缺少則中止服務。
  - 生產環境定期輪換密鑰。

### F-02（高）登入端點缺少暴力嘗試防護

- 風險等級：高
- 位置：`server/routes/auth.js:13`
- 問題描述：TOTP 登入未加 rate limit / 失敗鎖定 / 退避策略。
- 影響：可被高頻猜測 6 位驗證碼，增加帳號被入侵風險。
- 修正建議：
  - 對 `/api/auth/login` 加入 IP + 裝置指紋限流。
  - 連續失敗後短暫鎖定。
  - 記錄異常登入行為並告警。

### F-03（中）交易 API 輸入校驗不足，易產生 500 或髒資料

- 風險等級：中
- 位置：
  - `server/routes/transactions.js:85`
  - `server/routes/transactions.js:96`
  - `server/routes/transactions.js:143`
  - `server/routes/transactions.js:144`
- 問題描述：`amount/type/account_id/category_id/date/time` 缺少嚴格驗證與範圍控制。
- 影響：非法輸入可能導致 DB 例外（500）、錯誤記錄、統計失真。
- 修正建議：
  - 在路由層加入 schema 驗證（例如 Zod/Joi）。
  - `amount` 需為有限正數；`type` 僅允許 `income|expense`。
  - `account_id/category_id` 必須是合法整數且存在。
  - `date/time` 驗證格式與實際可解析性。

### F-04（中）日期採 UTC 截字串，存在時區錯日

- 風險等級：中
- 位置：
  - `client/src/components/TransactionForm.jsx:7`
  - `server/routes/ai.js:33`
  - `server/bot/handler.js:181`
- 問題描述：多處使用 `toISOString().split('T')[0]` 取日期。
- 影響：本地時區在日界線附近會被記到前一天或後一天。
- 修正建議：
  - 統一改為本地時區日期格式化（手動組 `YYYY-MM-DD`）。
  - 前後端共用同一套日期工具函式，避免分歧。

### F-05（中）刪除分類後列表未即時刷新，前端顯示暫時不一致

- 風險等級：中
- 位置：
  - `server/routes/categories.js:55`
  - `client/src/pages/Dashboard.jsx:188`
- 問題描述：後端刪除分類時會把交易 `category_id` 設空，但前端僅刷新分類列表，未刷新交易列表。
- 影響：使用者短時間看到舊分類標籤，造成資料認知不一致。
- 修正建議：分類更新後同時執行 `fetchTransactions()`。

### F-06（中）匯入腳本與現行交易語義不一致

- 風險等級：中
- 位置：
  - `scripts/seed-data.js:35`
  - `scripts/seed-data.js:39`
  - `server/db.js:40`
  - `server/db.js:64`
- 問題描述：匯入腳本沿用「收入負數」舊模型，但主系統已改成 `type` 區分收入/支出且 `amount` 正規化。
- 影響：匯入後可能出現 `expense + 負金額` 混亂資料，影響餘額與收支統計。
- 修正建議：
  - 匯入時明確寫入 `type`。
  - 強制 `amount = ABS(amount)`，以 `type` 表示方向。
  - 匯入前後加一致性檢查 SQL。

### F-07（低）Telegram Webhook 路由未掛載，且 Token 有弱預設值

- 風險等級：低
- 位置：
  - `server/routes/telegram.js:10`
  - `server/server.js:17`
  - `server/bot/handler.js:3`
- 問題描述：Webhook 路由檔存在但未在 server 掛載；Bot 存取 token 仍有弱預設值。
- 影響：目前 Bot Webhook 功能不會生效；若未來啟用且保留預設 token，存在未授權風險。
- 修正建議：
  - 若要啟用 Bot：先掛載路由、移除預設 token、驗證 Telegram webhook 來源。
  - 若不啟用 Bot：刪除未使用代碼或明確標註停用。

## 三、修復優先順序（建議）

1. 立即修復（24 小時內）
   - F-01 JWT 弱預設密鑰
   - F-02 登入防暴力嘗試
2. 短期修復（3 天內）
   - F-03 交易 API schema 校驗
   - F-04 日期時區一致化
3. 中期修復（7 天內）
   - F-05 分類刪除後前端即時同步
   - F-06 匯入腳本語義一致性
   - F-07 Telegram 功能收斂（啟用或移除）

## 四、冗餘代碼清單（可清理）

### R-01（未使用）`onBatchSave` prop 僅宣告未使用

- 位置：`client/src/components/TransactionForm.jsx:5`
- 現況：元件 props 有 `onBatchSave`，但未被傳入、未被實際使用。
- 建議：刪除該 prop 宣告，避免誤導維護者。

### R-02（未使用）`onDelete` callback 鏈已成死路徑

- 位置：
  - `client/src/pages/Dashboard.jsx:89`
  - `client/src/pages/Dashboard.jsx:165`
  - `client/src/components/TransactionList.jsx:1`
- 現況：`Dashboard` 傳入 `onDelete` 給 `TransactionList`，但 `TransactionList` 內沒有呼叫 `onDelete`。
- 建議：移除未使用的 `handleDelete` 與 `onDelete` 傳遞，降低維護成本。

### R-03（可簡化）交易刪除透過 `window` 自訂事件，結構偏冗餘

- 位置：
  - `client/src/components/TransactionForm.jsx:114`
  - `client/src/pages/Dashboard.jsx:65`
- 現況：`TransactionForm` 以 `dispatchEvent('delete-tx')` 觸發刪除，`Dashboard` 再以 `addEventListener` 接收處理。
- 建議：改為 props callback 直接呼叫刪除函式，避免跨元件全域事件耦合。

### R-04（未掛載）Telegram webhook 路由目前不可達

- 位置：
  - `server/routes/telegram.js:10`
  - `server/server.js:17`
- 現況：路由文件存在，但 `server.js` 未 `app.use('/api/telegram', ...)` 掛載。
- 建議：
  - 若不啟用 Telegram：移除未使用路由與相依程式碼。
  - 若要啟用：補掛載並加上 webhook 驗證保護。

## 五、已執行驗證

- 指令：`npm run build`
- 結果：成功（前端 `vite build` 完成）

## 六、未覆蓋項目（本次未做）

- 自動化測試覆蓋率評估（專案目前無測試檔）
- 壓力測試 / 併發資料一致性測試
- 真實對外滲透測試（黑箱）
- 第三方服務（Gemini/Telegram/Google Sheets）權限與金鑰管理實測
